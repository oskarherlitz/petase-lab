# Post-Generation Mutation Strategy

## Decision: Use Post-Generation Mutation ✅

**Rationale:**
- Pipeline is validated (gates work correctly)
- Much more efficient than generating millions of sequences
- Practical for production use
- Only 3 positions are mutated (rest is natural ProGen2 generation)

## Implementation

### Step 1: Generate Sequences Freely
```bash
python scripts/progen2_smoke_test.py run_20251229_progen2_small_r1_smoketest --num-samples 100
```

This generates sequences without constraints on positions 131, 177, 208.

### Step 2: Filter by Other Gates
Sequences are filtered by:
- ✅ Token cleanup
- ✅ Length (263 aa)
- ❌ Hard locks (will fail - that's expected)

### Step 3: Apply Catalytic Triad Mutations
For sequences that passed length gate, mutate:
- Position 131 → S
- Position 177 → D
- Position 208 → H

```bash
python scripts/apply_catalytic_triad.py \
  runs/run_20251229_progen2_small_r1_smoketest/candidates/candidates.length_pass.fasta \
  runs/run_20251229_progen2_small_r1_smoketest/candidates/candidates.filtered.fasta
```

### Step 4: Continue Pipeline
Mutated sequences now:
- ✅ Have correct length (263 aa)
- ✅ Have catalytic triad (S131, D177, H208)
- ✅ Can proceed to identity buckets, uniqueness, composition gates
- ✅ Can proceed to AF/Rosetta stages

## Example Workflow

```bash
# 1. Generate sequences
python scripts/progen2_smoke_test.py run_20251229_progen2_small_r1_smoketest --num-samples 100

# 2. Apply catalytic triad mutations
python scripts/apply_catalytic_triad.py \
  runs/run_20251229_progen2_small_r1_smoketest/candidates/candidates.length_pass.fasta \
  runs/run_20251229_progen2_small_r1_smoketest/candidates/candidates.filtered.fasta

# 3. Continue with remaining gates (identity, uniqueness, etc.)
# (To be implemented in full pipeline)
```

## Why This Works

1. **Efficiency:** Generate 100 sequences → mutate the good ones, rather than generate 8,000+ sequences
2. **Natural sequences:** 260 out of 263 positions are naturally generated by ProGen2
3. **Guaranteed triad:** All sequences will have the required catalytic residues
4. **Practical:** This is how most protein design pipelines work in practice

## Alternative: Full Run (Optional)

If you want to validate the probability math, you can still do a full run:
```bash
# This will take ~11-18 hours and might still get 0 matches
python scripts/progen2_smoke_test.py run_full_test --num-samples 8000
```

But this is not recommended for production use - it's just for validation/testing.

