# AlphaFold Structure Prediction Guide

## Overview

This guide explains how to use **AlphaFold** to predict 3D structures for sequences generated by the Progen2 pipeline.

**AlphaFold** is DeepMind's state-of-the-art protein structure prediction tool. It's more accurate than ColabFold but requires more setup.

## Quick Start

### Step 1: Get Your Progen2 Sequences

After running the Progen2 pipeline, you'll have a ranked FASTA file:

```bash
# Example location
runs/run_20251230_progen2_medium_r1_test/candidates/candidates.ranked.fasta
```

### Step 2: Run AlphaFold

**Option A: Using the script (recommended)**

```bash
# Predict structures for top candidates
bash scripts/alphafold_predict.sh \
  runs/run_20251230_progen2_medium_r1_test/candidates/candidates.ranked.fasta

# Or limit to first 5 sequences
bash scripts/alphafold_predict.sh \
  runs/run_20251230_progen2_medium_r1_test/candidates/candidates.ranked.fasta \
  runs/alphafold_predictions \
  5
```

**Option B: Using Python script**

```bash
python scripts/alphafold_predict.py \
  runs/run_20251230_progen2_medium_r1_test/candidates/candidates.ranked.fasta \
  --max-sequences 10 \
  --output-dir runs/alphafold_predictions
```

---

## Installation Options

AlphaFold requires significant setup. Choose the option that works best for you:

### Option 1: ColabFold (Easier Alternative) ⭐ Recommended

**ColabFold** is faster and easier to set up, with similar accuracy:

```bash
# Use ColabFold instead
bash scripts/colabfold_predict.sh \
  runs/run_20251230_progen2_medium_r1_test/candidates/candidates.ranked.fasta
```

See [COLABFOLD_GUIDE.md](COLABFOLD_GUIDE.md) for details.

### Option 2: AlphaFold via Docker

**Requirements:**
- Docker installed
- ~3TB disk space for databases
- GPU recommended (but not required)

**Setup:**

1. **Install Docker** (if not already installed)

2. **Download AlphaFold Docker image:**
   ```bash
   docker pull alphafold/alphafold
   ```

3. **Download AlphaFold databases** (~3TB):
   ```bash
   # Follow instructions at:
   # https://github.com/deepmind/alphafold#genetic-databases
   ```

4. **Update config:**
   Edit `configs/alphafold.yaml` with your database paths:
   ```yaml
   params_path: /path/to/alphafold/params
   databases:
     uniref90: /path/to/uniref90
     mgnify: /path/to/mgnify
     pdb70: /path/to/pdb70
     uniprot: /path/to/uniprot
     pdb_mmcif: /path/to/pdb_mmcif
   ```

5. **Set environment variable:**
   ```bash
   export ALPHAFOLD_DB_PATH=/path/to/alphafold_db
   ```

6. **Run prediction:**
   ```bash
   bash scripts/alphafold_predict.sh your_sequences.fasta
   ```

### Option 3: AlphaFold Local Installation

**Requirements:**
- Python 3.8+
- CUDA-capable GPU (recommended)
- ~3TB disk space
- Conda

**Setup:**

1. **Clone AlphaFold repository:**
   ```bash
   git clone https://github.com/deepmind/alphafold.git
   cd alphafold
   ```

2. **Install dependencies:**
   ```bash
   conda env create -f environment.yml
   conda activate alphafold
   pip install -r requirements.txt
   ```

3. **Download databases** (see AlphaFold documentation)

4. **Set environment variables:**
   ```bash
   export ALPHAFOLD_PATH=/path/to/alphafold
   export ALPHAFOLD_DB_PATH=/path/to/alphafold_db
   ```

5. **Run prediction:**
   ```bash
   bash scripts/alphafold_predict.sh your_sequences.fasta
   ```

### Option 4: AlphaFold via Google Colab

**No installation needed!**

1. **Open AlphaFold Colab notebook:**
   https://colab.research.google.com/github/deepmind/alphafold/blob/main/notebooks/AlphaFold.ipynb

2. **Upload your FASTA file** (from Progen2 pipeline)

3. **Run the notebook**

4. **Download results**

**Pros:**
- No installation
- Free GPU access
- Easy to use

**Cons:**
- Limited to one sequence at a time
- Requires internet
- Time limits on free tier

---

## Workflow: Progen2 → AlphaFold

### Complete Pipeline

```bash
# 1. Generate sequences with Progen2
python scripts/run_progen2_pipeline.py run_20251230_progen2_medium_r1_test \
  --num-samples 50 \
  --model progen2-medium

# 2. Review candidates
# Check: runs/run_20251230_progen2_medium_r1_test/candidates/candidates.ranked.csv

# 3. Predict structures with AlphaFold
bash scripts/alphafold_predict.sh \
  runs/run_20251230_progen2_medium_r1_test/candidates/candidates.ranked.fasta \
  runs/alphafold_predictions \
  10  # Limit to top 10

# 4. Analyze results
# Check: runs/alphafold_predictions/
#   - *_ranked_1.pdb: Best structure
#   - *_plddt.png: Confidence scores
#   - *_pae.png: Predicted errors
```

### Output Files

AlphaFold generates several files per sequence:

- **`*_ranked_1.pdb`**: Best-ranked structure model (use this one!)
- **`*_ranked_2.pdb`** through **`*_ranked_5.pdb`**: Alternative models
- **`*_plddt.png`**: Per-residue confidence plot (higher = more confident)
- **`*_pae.png`**: Predicted aligned error matrix
- **`*_scores.json`**: Confidence scores in JSON format

### Interpreting Results

**pLDDT scores:**
- **>90**: Very high confidence
- **70-90**: Confident
- **50-70**: Low confidence
- **<50**: Very low confidence (may be disordered)

**What to look for:**
1. **High pLDDT** (>70) across the structure
2. **Low PAE** in important regions (e.g., catalytic site)
3. **Consistent fold** across multiple models
4. **Reasonable structure** (no major clashes, proper geometry)

---

## Batch Processing Multiple Sequences

### Process All Candidates

```bash
# Process all sequences (may take hours/days)
bash scripts/alphafold_predict.sh \
  runs/run_20251230_progen2_medium_r1_test/candidates/candidates.ranked.fasta \
  runs/alphafold_all_predictions \
  1000  # Process up to 1000 sequences
```

### Process Top N Candidates

```bash
# First, extract top 10 sequences
head -20 runs/run_20251230_progen2_medium_r1_test/candidates/candidates.ranked.fasta \
  > top10_candidates.fasta

# Then predict
bash scripts/alphafold_predict.sh top10_candidates.fasta
```

---

## Integration with Rosetta

After AlphaFold prediction, you can:

1. **Use AlphaFold structures as starting points for Rosetta:**
   ```bash
   # Relax AlphaFold structure with Rosetta
   bash scripts/rosetta_relax.sh \
     runs/alphafold_predictions/sequence_ranked_1.pdb
   ```

2. **Compare AlphaFold vs Rosetta designs:**
   - Load both structures in PyMOL
   - Calculate RMSD
   - Check agreement in key regions

3. **Run stability calculations:**
   ```bash
   # Calculate ΔΔG with FoldX or Rosetta
   # Use AlphaFold structure as input
   ```

---

## Troubleshooting

### "AlphaFold not found"

**Solution:** Install AlphaFold or use ColabFold instead:
```bash
bash scripts/colabfold_predict.sh your_sequences.fasta
```

### "Out of memory"

**Solutions:**
- Reduce number of sequences
- Use ColabFold (uses less memory)
- Increase system RAM
- Use GPU if available

### "Database not found"

**Solution:** Update `configs/alphafold.yaml` with correct database paths, or set `ALPHAFOLD_DB_PATH` environment variable.

### "Too slow"

**Solutions:**
- Use ColabFold (faster)
- Limit number of sequences
- Use GPU acceleration
- Use `--db_preset=reduced_dbs` (faster but less accurate)

### "Docker permission denied"

**Solution:**
```bash
sudo usermod -aG docker $USER
# Then log out and back in
```

---

## Comparison: AlphaFold vs ColabFold

| Feature | AlphaFold | ColabFold |
|---------|-----------|-----------|
| **Accuracy** | Gold standard | Very similar |
| **Speed** | Slower | Faster (MMseqs2) |
| **Setup** | Complex (~3TB) | Easy (web or pip) |
| **Batch** | Yes | Limited (web) |
| **Cost** | Free (local) | Free (web) |
| **GPU** | Recommended | Optional |

**Recommendation:** 
- **Use ColabFold** for most cases (easier, faster, similar accuracy)
- **Use AlphaFold** if you need maximum accuracy or have it already set up

---

## Next Steps

After AlphaFold prediction:

1. **Review structures** in PyMOL or ChimeraX
2. **Check pLDDT scores** - filter low-confidence regions
3. **Compare with WT structure** - check fold preservation
4. **Run Rosetta relaxation** - refine structures
5. **Calculate stability** - run ΔΔG calculations
6. **Select best candidates** - combine all metrics

---

## References

- **AlphaFold GitHub**: https://github.com/deepmind/alphafold
- **AlphaFold Paper**: Jumper et al., Nature 2021
- **ColabFold**: https://github.com/sokrypton/ColabFold (easier alternative)
- **AlphaFold Colab**: https://colab.research.google.com/github/deepmind/alphafold/blob/main/notebooks/AlphaFold.ipynb

---

## Example: Complete Workflow

```bash
# 1. Generate sequences
python scripts/run_progen2_pipeline.py my_run --num-samples 100

# 2. Check results
cat runs/my_run/candidates/candidates.ranked.csv | head -20

# 3. Extract top 5 sequences
head -10 runs/my_run/candidates/candidates.ranked.fasta > top5.fasta

# 4. Predict structures (using ColabFold - easier)
bash scripts/colabfold_predict.sh top5.fasta runs/colabfold_top5

# OR use AlphaFold (if installed)
bash scripts/alphafold_predict.sh top5.fasta runs/alphafold_top5 5

# 5. Review structures
# Open runs/alphafold_top5/*_ranked_1.pdb in PyMOL

# 6. Relax with Rosetta
for pdb in runs/alphafold_top5/*_ranked_1.pdb; do
    bash scripts/rosetta_relax.sh "$pdb"
done

# 7. Calculate stability
# Run FoldX or Rosetta ΔΔG calculations
```

---

## Questions?

- See [COLABFOLD_GUIDE.md](COLABFOLD_GUIDE.md) for ColabFold (easier option)
- See [PROGEN2_WORKFLOW.md](PROGEN2_WORKFLOW.md) for Progen2 pipeline details
- Check AlphaFold documentation: https://github.com/deepmind/alphafold

